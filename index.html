<link href="css/quill.snow.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


<body onload="timeout_loader()">
<div id="loader"></div>
<main style="padding: 10px; margin: 20px;">
	<div class="jumbotron" style="display:none;" id="main_jumbo">
		<h3>Quill Spellcheck Demo</h3>
		<h6>Small dictionary (10,000 words) loaded</h6>
		<h6>Double click on highlighted words</h6>

		<div class="row">

			<div id="editor" spellcheck="false" class="col-md-6" style="height: 512px">
				I started my schooling as the majority did in my area, at the local primarry school. I then went to the
				local secondarry school and recieved grades in English, Maths, Phisics, Biology, Geography, Art,
				Graphical Comunication and Philosophy of Religeon. I'll not bore you with the A levels and above. Notice
				the ambigous English qualification above. It was, in truth, a cource dedicated to reading Lord of the
				flies and other gems, and a weak atempt at getting us to commprehend them. Luckilly my middle class
				upbringing gave me a head start as I was already aquainted with that sort of langauge these books used
				(and not just the Peter and Jane books) and had read simillar books before. I will neverr be able to put
				that paticular cource down as much as I desire to because, for all its faults, it introduced me to
				Steinbeck, Malkovich and the wonders of Lenny, mice and pokets. My education never included one iota of
				grammar. Lynn Truss points out in Eats, shoots and leaves that many people were excused from the rigours
				of learning English grammar during their schooling over the last 30 or so years because the majority or
				decision makers decided one day that it might hinder imagination and expresion (so what, I ask, happened
				to all those expresive and imaginative people before the ruling?).
			</div>


		</div>

		<button type="button" class="btn btn-primary" style="margin-top: 30px" onclick="highlightMisspellings()">
			Check Spelling
		</button>

	</div>


</main>
</body>


<script src="js/words.js"></script>
<script src="js/fuzzyset.js"></script>
<script src="js/quill.js"></script>
<script src="js/spellcheck.js"></script>
<script src="js/jquery-3.5.1.slim.min.js"></script>

<script>
    // Initialize Quill object
    let quill;
    quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: false
        }
    });

    // Tooltip is used to show suggestions
    const Tooltip = Quill.import('ui/tooltip');
    let suggestionTooltip = new Tooltip(quill);

    /*
        A mapping of:
		[word_start_index, word_length] => [word, suggestions_list]
	*/
    let corrections = {};

    // Highlights misspelled words in red
    function highlightMisspellings() {
        // clean the text: remove any carriage returns, double spaces, etc.
        let cleaned_text = quill.getText().replace(/[\n\r]+/g, '').replace(/\s{2,10}/g, ' ');
        let tokens = cleaned_text.split(' ');
        quill.setText(cleaned_text);
        quill.formatText('color', 'black');

        corrections = {};
        let start = 0;
        for (const token of tokens) {
            let suggestions = getSuggestions(token);
            if (suggestions.length !== 0) {
                quill.formatText(start, token.length, 'color', 'red', 'api');
                let [token_start, word] = splitToken(token);
                corrections[[start + token_start.length, word.length]] = {
                    'token': token,
                    'suggestions': suggestions,
                    'actualStart': start,
                    'actualLength': token.length
                };
            }

            start += token.length + 1  // +1 for space
        }
    }

    // Use suggestion from tooltip to change the selected text
    function applySuggestion(start, length, suggestion) {
        quill.deleteText(start, length, 'api');
        quill.insertText(start, suggestion, 'api');
        suggestionTooltip.hide();
        highlightMisspellings();
    }

    // This listens to user selection event and based on that displays the tooltip
    quill.on('selection-change', function (range) {
        if (range && range.length !== 0 && [range.index, range.length] in corrections) {
            let cur_corrections = corrections[[range.index, range.length]];
            let suggestions = cur_corrections['suggestions'];
            let actualStart = cur_corrections['actualStart'];
            let actualLength = cur_corrections['actualLength'];

            if (suggestions.length === 0) {
                return;
            }
            let bounds = quill.getBounds(actualStart, actualLength);
            suggestionTooltip.root.innerHTML = '';
            for (let suggest of suggestions) {
                suggestionTooltip.root.innerHTML += `
         <a onclick='applySuggestion(${actualStart}, ${actualLength}, "${suggest}")'>${suggest}</a></br>
        `
            }
            suggestionTooltip.show();
            suggestionTooltip.position(bounds);
        } else {
            suggestionTooltip.hide();
        }

    });

    $(document).ready(highlightMisspellings());

    let timout_var;

    function timeout_loader() {
        timout_var = setTimeout(showPage, 100);
    }

    function showPage() {
        document.getElementById("loader").style.display = "none";
        document.getElementById("main_jumbo").style.display = "block";
    }


</script>
